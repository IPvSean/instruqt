# Workflow name
name: Cache AAP installer 

# Controls when the workflow will run
on:
  # Manually from actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:

  # This workflow contains a single job called "build"
  build:
    permissions:
      contents: 'read'
      id-token: 'write'
    runs-on: ubuntu-latest
    environment: deploy
    steps:

    # In this job, all steps begin with a name
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        ref: 'main' 

    - name: Use gcloud CLI
      run: gcloud info

    - name: Check pip cache
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip' # caching pip dependencies

    - name: Install requirements
      run: pip install -r requirements.txt 
      
    - name: Install collections
      run: ansible-playbook $HOME/work/instruqt/instruqt/images/ansible/workshop-collection-install.yml

    - name: Check installer cache
      uses: actions/cache@v3
      id: aap-cache
      with:
        path: $HOME/work/instruqt/instruqt/.github/workflows/ansible
        key: aaptargz
    
    - name: Download installer
      id: download-aap
      if: steps.aap-cache.outputs.cache-hit != 'true'
      run: ansible-playbook $HOME/work/instruqt/instruqt/.github/workflows/ansible/build-aap-cache.yml
      env:
        REDHAT_OFFLINE_TOKEN: ${{ secrets.REDHAT_OFFLINE_TOKEN }}
        REDHAT_USERNAME: ${{ secrets.REDHAT_USERNAME }}
        REDHAT_PASSWORD: ${{ secrets.REDHAT_PASSWORD }}
        
    - name: Check path
      run: ls $HOME/work/instruqt/instruqt/.github/workflows/ansible/
        
    - name: Cache installer
      id: aap-cache-save
      if: steps.aap-cache.outputs.cache-hit != 'true'
      uses: actions/cache/save@v3
      with:
        path: $HOME/work/instruqt/instruqt/.github/workflows/ansible
        key: aaptargz
